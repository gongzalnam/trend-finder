<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trend Finder</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--txt:#e5e7eb;--accent:#1d4ed8;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Malgun Gothic}
  .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 14px}
  .tabs{display:flex;gap:8px;margin:8px 0 16px}
  .tab{padding:10px 14px;border-radius:10px;background:#0b1220;color:#cbd5e1;cursor:pointer;border:1px solid #1f2937}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}
  .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:14px;margin:10px 0}
  .row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;margin:8px 0}
  .row > label{color:var(--muted);font-size:13px}
  input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #263244;background:#0b1220;color:#e5e7eb}
  .rg{display:flex;gap:8px}
  .rg .chip{flex:1;text-align:center;padding:10px;border-radius:10px;border:1px solid #243041;background:#0b1220;color:#cbd5e1;cursor:pointer}
  .rg .chip.active{background:#113476;color:#fff;border-color:transparent}
  .actions{display:flex;gap:10px;margin-top:6px}
  .btn{background:var(--accent);border:none;color:#fff;cursor:pointer}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid #1f2937;font-size:13px;text-align:left}
  th{color:#93c5fd;font-weight:600;background:#0b1220;position:sticky;top:0}
  a{color:#93c5fd;text-decoration:none}
  .right{text-align:right}
</style>
</head>
<body>
<div class="wrap">
  <h1>Trend Finder</h1>

  <!-- 탭 -->
  <div class="tabs">
    <button class="tab active" data-pane="pane-channel">채널명 검색</button>
    <button class="tab" data-pane="pane-title">영상 제목 검색</button>
  </div>

  <!-- 채널명으로 채널 검색 -->
  <div id="pane-channel" class="card">
    <div class="row">
      <label>채널명</label>
      <input id="ch-term" placeholder="예) ENA, 단테, 곽튜브…" />
    </div>
    <div class="row">
      <label>기간</label>
      <div class="rg" data-name="ch-period">
        <div class="chip active" data-val="30d">한 달 이내</div>
        <div class="chip" data-val="7d">일주일 이내</div>
        <div class="chip" data-val="24h">24시간 이내</div>
      </div>
    </div>
    <div class="row">
      <label>길이</label>
      <select id="ch-duration">
        <option value="any">모든 길이</option>
        <option value="short">짧음(&lt;4분)</option>
        <option value="medium">중간(4~20분)</option>
        <option value="long">김(&gt;20분)</option>
      </select>
    </div>
    <div class="row">
      <label>최소 조회수</label>
      <input id="ch-min" type="number" min="0" step="100" value="1000" />
    </div>
    <div class="row">
      <label>결과 개수</label>
      <select id="ch-limit">
        <option>10</option><option>20</option><option>30</option><option>50</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn" id="btn-ch">채널 영상 검색 (Enter)</button>
      <span class="muted">채널ID를 찾아 **그 채널의 업로드만** 조회합니다.</span>
    </div>
  </div>

  <!-- 영상 제목으로만 검색 (제목 필터) -->
  <div id="pane-title" class="card" style="display:none">
    <div class="row">
      <label>영상 제목</label>
      <input id="ti-term" placeholder="예) 시니어 건강, 대구 가구 리폼…" />
    </div>
    <div class="row">
      <label>기간</label>
      <div class="rg" data-name="ti-period">
        <div class="chip active" data-val="30d">한 달 이내</div>
        <div class="chip" data-val="7d">일주일 이내</div>
        <div class="chip" data-val="24h">24시간 이내</div>
      </div>
    </div>
    <div class="row">
      <label>길이</label>
      <select id="ti-duration">
        <option value="any">모든 길이</option>
        <option value="short">짧음(&lt;4분)</option>
        <option value="medium">중간(4~20분)</option>
        <option value="long">김(&gt;20분)</option>
      </select>
    </div>
    <div class="row">
      <label>최소 조회수</label>
      <input id="ti-min" type="number" min="0" step="100" value="1000" />
    </div>
    <div class="row">
      <label>결과 개수</label>
      <select id="ti-limit">
        <option>10</option><option>20</option><option>30</option><option>50</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn" id="btn-ti">제목으로만 검색 (Ctrl+Enter)</button>
      <span class="muted">API 결과에서 **제목에만 일치**하도록 추가 필터링합니다.</span>
    </div>
  </div>

  <!-- 결과 -->
  <div class="card">
    <div class="muted" id="status">대기 중…</div>
    <div style="overflow:auto;max-height:60vh">
      <table id="tbl" style="display:none">
        <thead>
          <tr>
            <th style="width:50%">제목</th>
            <th>VPH</th>
            <th>좋아요율</th>
            <th>댓글/시간</th>
            <th class="right">점수</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // 1) 여기에 당신의 Apps Script /exec URL
  const WEBAPP = "https://script.google.com/macros/s/AKfycbzHtAOeX8S3V1F9JtmYtDkabk54bhubexI54HkLk_EUM5GnFRtaeljBpNUQiZ_bbu0m/exec";

  // ---- 탭 전환
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('[id^="pane-"]').forEach(p => p.style.display='none');
    document.getElementById(t.dataset.pane).style.display = '';
  }));

  // ---- 칩(기간) 선택
  function bindChipGroup(name){
    const g = document.querySelector(`.rg[data-name="${name}"]`);
    g.addEventListener('click', e=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      g.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
    });
    return ()=> g.querySelector('.chip.active').dataset.val;
  }
  const getChPeriod = bindChipGroup('ch-period');
  const getTiPeriod = bindChipGroup('ti-period');

  // ---- 유틸
  function fmtPct(x){ return (x*100).toFixed(2)+'%'; }
  function setStatus(msg){ document.getElementById('status').textContent = msg; }
  function render(items){
    const tbl = document.getElementById('tbl');
    const tb = tbl.querySelector('tbody');
    tb.innerHTML = '';
    if(!items.length){ tbl.style.display='none'; return; }
    for(const v of items){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><div style="font-weight:600">${v.title}</div>
            <div class="muted">${v.channelTitle}</div></td>
        <td>${v.vph?.toLocaleString?.() ?? 0}</td>
        <td>${fmtPct(v.likeRate||0)}</td>
        <td>${v.cph?.toFixed?.(2) ?? '0.00'}</td>
        <td class="right">${v.score?.toLocaleString?.() ?? 0}</td>
        <td><a href="${v.url}" target="_blank">보기</a></td>
      `;
      tb.appendChild(tr);
    }
    tbl.style.display = '';
  }

  async function request(params){
    // 15초 타임아웃
    const ctl = new AbortController();
    const killer = setTimeout(()=>ctl.abort(), 15000);
    const url = WEBAPP + "?" + new URLSearchParams(params).toString();
    const res = await fetch(url, { signal: ctl.signal, cache: 'no-store' });
    clearTimeout(killer);
    const text = await res.text();
    if(!text.trim().startsWith('{')) throw new Error('JSON이 아닌 응답: ' + text.slice(0,120));
    const data = JSON.parse(text);
    if(!data.ok) throw new Error(data.error || 'unknown');
    return data;
  }

  // ---- 채널명 → 채널ID 고정 검색
  async function searchChannel(){
    const term = document.getElementById('ch-term').value.trim();
    if(!term){ setStatus('채널명을 입력하세요.'); return; }
    setStatus('조회 중… (채널 영상)');
    try{
      const params = {
        mode:'channel',
        term,
        searchMode:'channel',         // ✅ 채널ID로만
        period:getChPeriod(),         // 30d/7d/24h
        duration:document.getElementById('ch-duration').value,
        region:'KR',
        minViews:document.getElementById('ch-min').value || 0,
        limit:document.getElementById('ch-limit').value || 10,
        sort:'score'
      };
      const data = await request(params);
      render(data.items || []);
      setStatus(`모드: 채널 / 결과: ${data.items?.length ?? 0}`);
    }catch(e){
      setStatus('오류: ' + e.message);
      render([]);
      console.error(e);
    }
  }

  // ---- 영상 제목으로만 검색 (제목 포함 필터)
  async function searchTitle(){
    const term = document.getElementById('ti-term').value.trim();
    if(!term){ setStatus('영상 제목 키워드를 입력하세요.'); return; }
    setStatus('조회 중… (제목 일치)');
    try{
      const params = {
        mode:'keyword',
        term,                         // API는 제목/설명/태그 전체를 보지만,
        period:getTiPeriod(),         // 아래에서 제목만 추가 필터링
        duration:document.getElementById('ti-duration').value,
        region:'KR',
        minViews:document.getElementById('ti-min').value || 0,
        limit:document.getElementById('ti-limit').value || 10,
        sort:'score'
      };
      const data = await request(params);
      // ✅ 제목에만 일치하도록 프런트에서 필터링
      const items = (data.items || []).filter(v =>
        (v.title || '').toLowerCase().includes(term.toLowerCase())
      );
      render(items);
      setStatus(`모드: 제목 / 결과: ${items.length}`);
    }catch(e){
      setStatus('오류: ' + e.message);
      render([]);
      console.error(e);
    }
  }

  // 버튼 & 단축키
  document.getElementById('btn-ch').addEventListener('click', searchChannel);
  document.getElementById('btn-ti').addEventListener('click', searchTitle);
  document.addEventListener('keydown', e=>{
    if(e.key === 'Enter' && !e.ctrlKey) searchChannel();
    if(e.key === 'Enter' && e.ctrlKey) searchTitle();
  });
</script>
</body>
</html>
